<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      /* --- åŸºç¤è¨­å®š --- */
      body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f4f9; color: #333; margin: 0; }
      .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
      
      h2, h3 { color: #2c3e50; }
      h2 { text-align: center; margin-top: 0; font-size: 1.5rem; }
      h3 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px; color: #1565c0; font-size: 1.1rem; }
      
      /* --- å°èˆªåˆ— --- */
      .nav-tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #ddd; overflow-x: auto; -webkit-overflow-scrolling: touch; }
      .nav-item { padding: 12px 20px; cursor: pointer; font-weight: bold; color: #666; white-space: nowrap; transition: 0.2s; border-bottom: 3px solid transparent; }
      .nav-item:hover { background-color: #f9f9f9; }
      .nav-item.active { border-bottom: 3px solid #2196F3; color: #2196F3; }
      
      .tab-content { display: none; animation: fadeIn 0.3s; }
      .tab-content.active { display: block; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

      /* --- è¡¨å–®å€åŸŸ --- */
      .form-header { display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 15px; margin-bottom: 20px; }
      .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
      .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1rem; }
      
      /* --- æœå°‹åˆ— --- */
      .search-bar { background: #e3f2fd; padding: 15px; border-radius: 6px; display: flex; gap: 15px; align-items: flex-end; margin-bottom: 20px; flex-wrap: wrap; }
      .search-item { flex: 1; min-width: 150px; }
      .search-item label { display: block; font-weight: bold; font-size: 0.85em; margin-bottom: 5px; color: #1565c0; }
      
      /* --- è¡¨æ ¼èˆ‡åˆ—è¡¨ --- */
      table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
      th { background-color: #2c3e50; color: white; padding: 10px; text-align: center; font-size: 0.9em; border: 1px solid #34495e; }
      td { padding: 8px; border-bottom: 1px solid #eee; font-size: 0.9em; border: 1px solid #eee; vertical-align: middle; }
      .v-divider { border-right: 2px solid #ddd; }
      
      input.amount { text-align: right; width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
      select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
      .text-right { text-align: right; }

      /* --- æŒ‰éˆ• --- */
      .btn { padding: 10px 15px; border: none; cursor: pointer; border-radius: 4px; color: white; font-size: 0.9em; transition: 0.2s; display: inline-block; text-align: center; }
      .btn:hover { opacity: 0.9; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
      .btn:disabled { background-color: #ccc; cursor: not-allowed; opacity: 1; box-shadow: none; }
      
      .btn-add { background-color: #2196F3; }
      .btn-search { background-color: #1565c0; width: 100%; }
      .btn-submit { background-color: #4CAF50; width: 100%; font-size: 1.1em; margin-top: 15px; padding: 12px; }
      .btn-update { background-color: #FF9800; width: 100%; font-size: 1.1em; margin-top: 15px; padding: 12px; }
      .btn-cancel { background-color: #9E9E9E; width: 100%; margin-top: 10px; padding: 10px; }
      .btn-remove { background-color: #ef5350; color: white; width: 30px; height: 30px; border-radius: 50%; padding: 0; line-height: 30px; }
      
      .btn-edit { background-color: #FF9800; margin-right: 5px; }
      .btn-delete { background-color: #c62828; } 
      .btn-refresh { background-color: #607d8b; }
      
      /* ä¸‹è¼‰æŒ‰éˆ• */
      .btn-download { background-color: #2e7d32; width: 100%; }

      /* åƒåœ¾æ¡¶å°ˆç”¨æŒ‰éˆ• */
      .btn-restore { background-color: #4CAF50; margin-right: 5px; }
      .btn-hard-delete { background-color: #333; }

      /* --- å¡ç‰‡å¼åˆ—è¡¨ (ç™¼ç¥¨å¡ç‰‡) --- */
      .invoice-card { border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px; padding: 15px; background: #fff; border-left: 5px solid #2196F3; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
      .invoice-card.deleted { border-left-color: #c62828; background-color: #fff5f5; }
      
      .invoice-header { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 10px; }
      .invoice-info { flex: 1; }
      .invoice-info h4 { margin: 0 0 5px 0; font-size: 1.1em; color: #333; }
      .invoice-meta { color: #666; font-size: 0.9em; }
      .invoice-actions { display: flex; gap: 5px; }
      
      .details-table { width: 100%; margin-top: 10px; background: #fafafa; border-radius: 4px; overflow: hidden; }
      .details-table th { background: #eee; color: #555; border: none; text-align: left; }
      
      /* --- çµ±è¨ˆèˆ‡è¨Šæ¯ --- */
      .totals { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 4px; border: 1px solid #eee; }
      .totals div { font-size: 1rem; font-weight: bold; }
      
      .msg-box { text-align: center; margin-top: 10px; display: none; padding: 15px; border-radius: 4px; font-weight: bold; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; box-shadow: 0 4px 10px rgba(0,0,0,0.2); min-width: 300px; }
      
      /* --- å ±è¡¨æ§åˆ¶å€ --- */
      .report-controls { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; background: #e3f2fd; padding: 15px; border-radius: 4px; margin-bottom: 20px; }
      .control-group { display: flex; align-items: center; gap: 10px; }
      .indent { padding-left: 20px; color: #555; }
      .indent-2 { padding-left: 40px; color: #777; }
      .total-row { font-weight: bold; background-color: #e3f2fd; }
      .subtotal-row { font-weight: bold; background-color: #f5f5f5; }

      /* =========================================
         RWD æ‰‹æ©Ÿç‰ˆé©é… (Max Width 768px)
         ========================================= */
      @media screen and (max-width: 768px) {
        body { padding: 10px; }
        .container { padding: 10px; }
        
        /* 1. è¡¨å–®æ¨™é ­å‚ç›´å †ç–Š */
        .form-header { grid-template-columns: 1fr; gap: 10px; }
        
        /* 2. éš±è—åŸæœ‰çš„ Table Header */
        #linesTable thead { display: none; }
        
        /* 3. å°‡ Table Row è½‰ç‚ºå¡ç‰‡ */
        #linesTable tbody tr {
          display: block;
          margin-bottom: 15px;
          border: 1px solid #ddd;
          border-radius: 8px;
          padding: 15px;
          background: #fff;
          box-shadow: 0 2px 4px rgba(0,0,0,0.05);
          position: relative;
        }

        /* 4. å°‡ Table Cell è½‰ç‚ºå€å¡Š */
        #linesTable td {
          display: block;
          border: none;
          padding: 5px 0;
          text-align: left;
        }
        
        /* ç§»é™¤åˆ†éš”ç·š td çš„æ¨£å¼ */
        #linesTable td.v-divider { border: none; }
        
        /* 5. èª¿æ•´è¼¸å…¥æ¡†èˆ‡é¸å–®å¯¬åº¦ */
        #linesTable select, 
        #linesTable input.amount { 
          width: 100%; 
          font-size: 16px; 
        }

        /* 6. ç‚ºæ‰‹æ©Ÿç‰ˆæ·»åŠ æ¬„ä½æ¨™ç±¤ */
        #linesTable td:nth-child(1)::before { content: "å€Ÿæ–¹ç§‘ç›®"; display: block; font-size: 0.8em; color: #888; margin-bottom: 2px; }
        #linesTable td:nth-child(2)::before { content: "å€Ÿæ–¹é‡‘é¡"; display: block; font-size: 0.8em; color: #888; margin-bottom: 2px; }
        #linesTable td:nth-child(3)::before { content: "è²¸æ–¹ç§‘ç›®"; display: block; font-size: 0.8em; color: #888; margin-bottom: 2px; }
        #linesTable td:nth-child(4)::before { content: "è²¸æ–¹é‡‘é¡"; display: block; font-size: 0.8em; color: #888; margin-bottom: 2px; }

        #linesTable td:last-child { text-align: right; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        
        /* 7. ç™¼ç¥¨åˆ—è¡¨åœ¨æ‰‹æ©Ÿä¸Šçš„å„ªåŒ– */
        .invoice-header { flex-direction: column; }
        .invoice-actions { width: 100%; justify-content: flex-end; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        
        /* 8. å ±è¡¨è¡¨æ ¼å„ªåŒ– */
        .text-right { text-align: left; }
        .report-controls { flex-direction: column; align-items: stretch; }
        
        /* 9. æœå°‹åˆ—å‚ç›´å †ç–Š */
        .search-bar { flex-direction: column; align-items: stretch; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- å°èˆªåˆ— -->
      <div class="nav-tabs">
        <div class="nav-item active" onclick="switchTab('entry')">ğŸ“ ç™¼ç¥¨ç™»éŒ„</div>
        <div class="nav-item" onclick="switchTab('list')">ğŸ” æŸ¥è©¢</div>
        <div class="nav-item" onclick="switchTab('report')">ğŸ“Š å ±è¡¨</div>
        <div class="nav-item" onclick="switchTab('trash')" style="color: #c62828;">ğŸ—‘ï¸ åƒåœ¾æ¡¶</div>
      </div>

      <!-- 1. ç™¼ç¥¨ç™»éŒ„ (Entry) -->
      <div id="tab-entry" class="tab-content active">
        <h2 id="formTitle">æ–°å¢ç™¼ç¥¨/å–®æ“š</h2>
        <div class="form-header">
          <div class="form-group"><label>ğŸ“… æ—¥æœŸ</label><input type="date" id="entryDate"></div>
          <div class="form-group"><label>ğŸ“ æ‘˜è¦/å“é …</label><input type="text" id="entryDesc" placeholder="ä¾‹å¦‚ï¼šéŠ·å”®å•†å“ã€æ”¯ä»˜æ°´é›»è²»"></div>
          <div class="form-group"><label>ğŸ”– å–®è™Ÿ (é¸å¡«)</label><input type="text" id="entryRef" placeholder="ä¾‹å¦‚ï¼šINV-2023001"></div>
        </div>
        
        <table id="linesTable">
          <thead>
            <tr>
              <th width="35%">å€Ÿæ–¹ç§‘ç›® (Debit)</th>
              <th width="15%" class="v-divider">å€Ÿæ–¹é‡‘é¡</th>
              <th width="35%">è²¸æ–¹ç§‘ç›® (Credit)</th>
              <th width="15%">è²¸æ–¹é‡‘é¡</th>
              <th width="5%"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button class="btn btn-add" onclick="addSplitLine()" style="width:100%">+ æ–°å¢åˆ†éŒ„è¡Œ</button>

        <div class="totals">
          <div>å€Ÿæ–¹ç¸½è¨ˆ: <span id="totalDebit">0</span></div>
          <div>è²¸æ–¹ç¸½è¨ˆ: <span id="totalCredit">0</span></div>
          <div id="balanceStatus" style="color: green;">(å¹³è¡¡)</div>
        </div>
        
        <button class="btn btn-submit" id="submitBtn" onclick="submitForm()">ğŸ’¾ å„²å­˜ç™¼ç¥¨</button>
        <div id="editButtons" style="display:none;">
          <button class="btn btn-update" id="updateBtn" onclick="updateForm()">âœ… ç¢ºèªä¿®æ”¹</button>
          <button class="btn btn-cancel" onclick="cancelEdit()">âŒ å–æ¶ˆç·¨è¼¯</button>
        </div>
      </div>

      <!-- 2. ç™¼ç¥¨æŸ¥è©¢ (List) -->
      <div id="tab-list" class="tab-content">
        <h2>ç™¼ç¥¨æŸ¥è©¢</h2>
        <div class="search-bar">
          <div class="search-item"><label>é–‹å§‹æ—¥æœŸ</label><input type="date" id="searchStart"></div>
          <div class="search-item"><label>çµæŸæ—¥æœŸ</label><input type="date" id="searchEnd"></div>
          <div class="search-item"><label>&nbsp;</label><button class="btn btn-search" onclick="loadInvoices()">ğŸ” æœå°‹</button></div>
          <div class="search-item"><label>&nbsp;</label><button class="btn btn-download" id="btnDlInv" onclick="downloadInvoiceExcel()">ğŸ“¥ ä¸‹è¼‰ Excel</button></div>
        </div>
        <div id="invoiceList">è«‹é¸æ“‡æ—¥æœŸç¯„åœä¸¦é»æ“Šæœå°‹...</div>
      </div>

      <!-- 3. è²¡å‹™å ±è¡¨ (Report) -->
      <div id="tab-report" class="tab-content">
        <h2>è²¡å‹™å ±è¡¨</h2>
        <div class="report-controls">
          <div class="control-group">
            <label><b>æ¨¡å¼ï¼š</b></label>
            <label><input type="radio" name="reportMode" value="year" onchange="toggleReportMode()" checked> å¹´åº¦</label>
            <label><input type="radio" name="reportMode" value="month" onchange="toggleReportMode()"> æœˆä»½</label>
          </div>
          <div class="control-group" id="yearSelector">
            <label>å¹´åº¦ï¼š</label>
            <select id="selYear" onchange="loadFinancials()" style="padding:5px;"></select>
          </div>
          <div class="control-group" id="monthSelector" style="display:none;">
            <label>æœˆä»½ï¼š</label>
            <input type="month" id="selMonth" onchange="loadFinancials()" style="padding:5px;">
          </div>
          <button class="btn btn-refresh" onclick="loadFinancials()">â†» åˆ·æ–°</button>
          <button class="btn btn-download" id="btnDlRep" onclick="downloadReportExcel()">ğŸ“¥ ä¸‹è¼‰ Excel</button>
        </div>
        
        <h3>1. ç¶œåˆæç›Šè¡¨</h3>
        <table id="incomeTable"><thead><tr><th>ç§‘ç›®</th><th class="text-right">é‡‘é¡</th></tr></thead><tbody></tbody></table>
        <h3>2. æ‰€æœ‰è€…æ¬Šç›Šè®Šå‹•è¡¨</h3>
        <table id="equityTable"><thead><tr><th>é …ç›®</th><th class="text-right">é‡‘é¡</th></tr></thead><tbody></tbody></table>
        <h3>3. ç¾é‡‘æµé‡è¡¨ (é–“æ¥æ³•)</h3>
        <table id="cfTable"><thead><tr><th>é …ç›®</th><th class="text-right">é‡‘é¡</th></tr></thead><tbody></tbody></table>
        <h3>4. è³‡ç”¢è² å‚µè¡¨</h3>
        <table id="balanceSheetTable"><thead><tr><th>ç§‘ç›®</th><th class="text-right">é‡‘é¡</th></tr></thead><tbody></tbody></table>
      </div>
      
      <!-- 4. åƒåœ¾æ¡¶ (Trash) -->
      <div id="tab-trash" class="tab-content">
        <h2 style="color:#c62828">ğŸ—‘ï¸ åƒåœ¾æ¡¶ (å·²åˆªé™¤ç™¼ç¥¨)</h2>
        <p style="text-align:center; color:#666; font-size:0.9em;">é€™è£¡é¡¯ç¤ºæ‰€æœ‰è¢«ã€Œè»Ÿåˆªé™¤ã€çš„ç™¼ç¥¨ã€‚æ‚¨å¯ä»¥é‚„åŸå®ƒå€‘ï¼Œæˆ–é¸æ“‡æ°¸ä¹…åˆªé™¤ã€‚</p>
        <button class="btn btn-refresh" onclick="loadTrash()" style="width:100%; margin-bottom:15px;">â†» åˆ·æ–°åƒåœ¾æ¡¶</button>
        <div id="trashList">è¼‰å…¥ä¸­...</div>
      </div>
    </div>

    <!-- è¨Šæ¯æç¤ºæ¡† -->
    <div id="msgBox" class="msg-box"></div>

    <script>
      let debitOptions = [], creditOptions = [], allAccountMap = {}, currentEditingId = null;

      window.onload = function() {
        const today = new Date();
        const dateStr = today.toISOString().split('T')[0];
        const mStr = (today.getMonth()+1).toString().padStart(2, '0');
        
        document.getElementById('entryDate').value = dateStr;
        document.getElementById('searchEnd').value = dateStr;
        document.getElementById('searchStart').value = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
        document.getElementById('selMonth').value = `${today.getFullYear()}-${mStr}`;

        const yearSel = document.getElementById('selYear');
        const cy = today.getFullYear();
        for(let y=cy-2; y<=cy+2; y++) {
          const opt = document.createElement('option'); opt.value = y; opt.text = y + 'å¹´'; if(y===cy) opt.selected = true; yearSel.add(opt);
        }

        google.script.run.withSuccessHandler(accts => {
          debitOptions = accts.map(a => `<option value="${a.code}">${a.code} ${a.name}</option>`);
          creditOptions = accts.map(a => `<option value="${a.code}">${a.code} ${a.name}</option>`);
          accts.forEach(a => allAccountMap[a.code] = a.name);
          addSplitLine(); 
        }).getAccountsList();
      };

      function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
        const navItems = document.querySelectorAll('.nav-item');
        if(tab === 'entry') navItems[0].classList.add('active');
        if(tab === 'list') navItems[1].classList.add('active');
        if(tab === 'report') { navItems[2].classList.add('active'); loadFinancials(); }
        if(tab === 'trash') { navItems[3].classList.add('active'); loadTrash(); }
        window.scrollTo(0,0);
      }
      
      function toggleReportMode() {
        const mode = document.querySelector('input[name="reportMode"]:checked').value;
        document.getElementById('yearSelector').style.display = mode === 'year' ? 'flex' : 'none';
        document.getElementById('monthSelector').style.display = mode === 'month' ? 'flex' : 'none';
        loadFinancials();
      }

      function addSplitLine(drCode='', drAmt=0, crCode='', crAmt=0) {
        const row = document.querySelector('#linesTable tbody').insertRow();
        row.innerHTML = `
          <td><select class="dr-sel"><option value="">(å€Ÿæ–¹ç§‘ç›®)</option>${debitOptions.join('')}</select></td>
          <td class="v-divider"><input type="number" class="amount debit" value="${drAmt}" placeholder="é‡‘é¡" oninput="calcTotals()"></td>
          <td><select class="cr-sel"><option value="">(è²¸æ–¹ç§‘ç›®)</option>${creditOptions.join('')}</select></td>
          <td><input type="number" class="amount credit" value="${crAmt}" placeholder="é‡‘é¡" oninput="calcTotals()"></td>
          <td><button class="btn btn-remove" onclick="this.closest('tr').remove();calcTotals()">âœ•</button></td>
        `;
        if(drCode) row.querySelector('.dr-sel').value = drCode; 
        if(crCode) row.querySelector('.cr-sel').value = crCode;
      }

      function calcTotals() {
        let d=0, c=0; 
        document.querySelectorAll('.debit').forEach(i=>d+=Number(i.value)); 
        document.querySelectorAll('.credit').forEach(i=>c+=Number(i.value));
        document.getElementById('totalDebit').innerText = d.toLocaleString(); 
        document.getElementById('totalCredit').innerText = c.toLocaleString();
        const s=document.getElementById('balanceStatus'), btnS=document.getElementById('submitBtn'), btnU=document.getElementById('updateBtn');
        const isBal = Math.abs(d-c)<0.01 && d>0; 
        s.innerText = isBal ? '(å¹³è¡¡)' : '(ä¸å¹³è¡¡)'; s.style.color = isBal ? 'green' : 'red'; btnS.disabled = !isBal; btnU.disabled = !isBal;
      }

      function getFormData() {
        const data = { date: document.getElementById('entryDate').value, description: document.getElementById('entryDesc').value, reference: document.getElementById('entryRef').value, lines: [] };
        document.querySelectorAll('#linesTable tbody tr').forEach(r => {
          const drCode = r.querySelector('.dr-sel').value; const drAmt = Number(r.querySelector('.debit').value);
          const crCode = r.querySelector('.cr-sel').value; const crAmt = Number(r.querySelector('.credit').value);
          if(drCode && drAmt > 0) data.lines.push({ accountCode: drCode, debit: drAmt, credit: 0 });
          if(crCode && crAmt > 0) data.lines.push({ accountCode: crCode, debit: 0, credit: crAmt });
        }); return data;
      }

      function submitForm() { 
        if(!confirm('ç¢ºå®šå„²å­˜å—ï¼Ÿ')) return;
        const btn=document.getElementById('submitBtn'); btn.disabled=true; btn.innerText='å„²å­˜ä¸­...'; 
        google.script.run.withSuccessHandler(()=>{ showMsg('å„²å­˜æˆåŠŸï¼','green'); resetForm(); btn.disabled=false; btn.innerText='ğŸ’¾ å„²å­˜ç™¼ç¥¨'; }).saveTransaction(getFormData()); 
      }
      function updateForm() { 
        if(!currentEditingId)return; 
        const btn=document.getElementById('updateBtn'); btn.disabled=true; btn.innerText='æ›´æ–°ä¸­...'; 
        const d=getFormData(); d.id=currentEditingId; 
        google.script.run.withSuccessHandler(()=>{ showMsg('æ›´æ–°æˆåŠŸï¼','green'); resetForm(); cancelEdit(); loadInvoices(); switchTab('list'); }).updateInvoice(d); 
      }
      function resetForm() { document.getElementById('entryDesc').value=''; document.getElementById('entryRef').value=''; document.querySelector('#linesTable tbody').innerHTML=''; addSplitLine(); calcTotals(); }
      function showMsg(txt, color) { const m=document.getElementById('msgBox'); m.innerText=txt; m.style.display='block'; m.style.background=color=='green'?'#e8f5e9':'#ffebee'; m.style.color=color=='green'?'#2e7d32':'#c62828'; setTimeout(()=>{m.style.display='none'}, 3000); }

      function editInvoice(str) {
        const inv = JSON.parse(decodeURIComponent(str)); currentEditingId = inv.id;
        document.getElementById('entryDate').value=inv.date; document.getElementById('entryDesc').value=inv.description; document.getElementById('entryRef').value=inv.reference;
        const tbody = document.querySelector('#linesTable tbody'); tbody.innerHTML = '';
        const debits = inv.lines.filter(l => l.debit > 0); const credits = inv.lines.filter(l => l.credit > 0);
        const maxLen = Math.max(debits.length, credits.length);
        for(let i=0; i<maxLen; i++) { const d = debits[i] || {accountCode:'', debit:0}; const c = credits[i] || {accountCode:'', credit:0}; addSplitLine(d.accountCode, d.debit, c.accountCode, c.credit); }
        calcTotals(); document.getElementById('formTitle').innerText='ç·¨è¼¯ç™¼ç¥¨ ('+inv.date+')'; document.getElementById('submitBtn').style.display='none'; document.getElementById('editButtons').style.display='block'; switchTab('entry'); 
      }
      function cancelEdit() { currentEditingId=null; document.getElementById('formTitle').innerText='æ–°å¢ç™¼ç¥¨/å–®æ“š'; document.getElementById('submitBtn').style.display='block'; document.getElementById('editButtons').style.display='none'; resetForm(); }

      function loadInvoices() {
        const s=document.getElementById('searchStart').value, e=document.getElementById('searchEnd').value, div=document.getElementById('invoiceList'); 
        div.innerHTML='<p style="text-align:center">æœå°‹ä¸­...</p>';
        google.script.run.withSuccessHandler(data => {
          if(data.length===0){div.innerHTML='<p style="text-align:center">æŸ¥ç„¡è³‡æ–™</p>';return;}
          div.innerHTML = renderInvoiceList(data, false);
        }).getInvoicesByDateRange(s, e);
      }

      function loadTrash() {
        const div = document.getElementById('trashList');
        div.innerHTML = '<p style="text-align:center">è¼‰å…¥ä¸­...</p>';
        google.script.run.withSuccessHandler(data => {
          if(data.length===0){ div.innerHTML='<p style="text-align:center">åƒåœ¾æ¡¶æ˜¯ç©ºçš„ ğŸ‘</p>'; return; }
          div.innerHTML = renderInvoiceList(data, true);
        }).getTrashedInvoices();
      }

      function renderInvoiceList(data, isTrashMode) {
        return data.map(item => {
          const str=encodeURIComponent(JSON.stringify(item));
          let detail = item.lines.map(d => { const name = allAccountMap[d.accountCode] || ''; return `<tr><td>${d.accountCode} ${name}</td><td class="text-right">${d.debit>0?d.debit.toLocaleString():''}</td><td class="text-right">${d.credit>0?d.credit.toLocaleString():''}</td></tr>`; }).join('');
          let btns = isTrashMode 
             ? `<button class="btn btn-restore" onclick="restoreInv('${item.id}')">â™»ï¸ é‚„åŸ</button><button class="btn btn-hard-delete" onclick="hardDeleteInv('${item.id}')">â˜ ï¸ æ°¸ä¹…åˆªé™¤</button>`
             : `<button class="btn btn-edit" onclick="editInvoice('${str}')">âœï¸</button><button class="btn btn-delete" onclick="deleteInv('${item.id}')">ğŸ—‘ï¸</button>`;
          return `<div class="invoice-card ${isTrashMode?'deleted':''}"><div class="invoice-header"><div class="invoice-info"><h4>${item.date} - ${item.description} <span style="font-size:0.8em;background:#eee;padding:2px 5px;border-radius:4px;">${item.reference||'ç„¡å–®è™Ÿ'}</span></h4><div class="invoice-meta">ç¸½é¡: $${item.total.toLocaleString()}</div></div><div class="invoice-actions">${btns}</div></div><table class="details-table"><thead><tr><th>ç§‘ç›®</th><th class="text-right">å€Ÿ</th><th class="text-right">è²¸</th></tr></thead><tbody>${detail}</tbody></table></div>`;
        }).join('');
      }

      function deleteInv(id) { if(confirm('ç¢ºå®šè¦ç§»è‡³åƒåœ¾æ¡¶å—ï¼Ÿ')) { google.script.run.withSuccessHandler(()=>{ showMsg('å·²ç§»è‡³åƒåœ¾æ¡¶', 'red'); loadInvoices(); }).deleteInvoice(id); } }
      function restoreInv(id) { google.script.run.withSuccessHandler(()=>{ showMsg('ç™¼ç¥¨å·²é‚„åŸï¼', 'green'); loadTrash(); }).restoreInvoice(id); }
      function hardDeleteInv(id) { if(confirm('è­¦å‘Šï¼šæ°¸ä¹…åˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')) { google.script.run.withSuccessHandler(()=>{ showMsg('å·²æ°¸ä¹…åˆªé™¤', 'red'); loadTrash(); }).hardDeleteInvoice(id); } }

      // --- Excel ä¸‹è¼‰åŠŸèƒ½ ---
      function downloadInvoiceExcel() {
        const s = document.getElementById('searchStart').value;
        const e = document.getElementById('searchEnd').value;
        const btn = document.getElementById('btnDlInv');
        btn.disabled = true; btn.innerText = 'è™•ç†ä¸­...';
        
        google.script.run.withSuccessHandler(url => {
          window.open(url, '_blank');
          btn.disabled = false; btn.innerText = 'ğŸ“¥ ä¸‹è¼‰ Excel';
        }).withFailureHandler(err => {
          alert('ä¸‹è¼‰å¤±æ•—ï¼š' + err.message);
          btn.disabled = false; btn.innerText = 'ğŸ“¥ ä¸‹è¼‰ Excel';
        }).exportInvoiceExcel(s, e);
      }

      function downloadReportExcel() {
        const mode = document.querySelector('input[name="reportMode"]:checked').value;
        let y, m = null;
        if (mode === 'year') { y = document.getElementById('selYear').value; } 
        else { const val = document.getElementById('selMonth').value; if(!val) { alert('è«‹é¸æ“‡æœˆä»½'); return; } const parts = val.split('-'); y = parts[0]; m = parts[1]; }
        
        const btn = document.getElementById('btnDlRep');
        btn.disabled = true; btn.innerText = 'è™•ç†ä¸­...';

        google.script.run.withSuccessHandler(url => {
          window.open(url, '_blank');
          btn.disabled = false; btn.innerText = 'ğŸ“¥ ä¸‹è¼‰ Excel';
        }).withFailureHandler(err => {
          alert('ä¸‹è¼‰å¤±æ•—ï¼š' + err.message);
          btn.disabled = false; btn.innerText = 'ğŸ“¥ ä¸‹è¼‰ Excel';
        }).exportReportExcel(Number(y), m ? Number(m) : null, mode);
      }

      function loadFinancials() {
        const mode = document.querySelector('input[name="reportMode"]:checked').value;
        const ids = ['incomeTable', 'equityTable', 'cfTable', 'balanceSheetTable'];
        ids.forEach(id => document.querySelector(`#${id} tbody`).innerHTML='<tr><td>é‹ç®—ä¸­...</td></tr>');
        
        let y, m = null;
        if (mode === 'year') { y = document.getElementById('selYear').value; } 
        else { const val = document.getElementById('selMonth').value; if(!val) return; const parts = val.split('-'); y = parts[0]; m = parts[1]; }

        google.script.run.withSuccessHandler(res => {
            const fmt = (n) => n.toLocaleString();
            let inc = renderSec(res.income.revenue, 'æ”¶å…¥', res.income.totalRevenue) + renderSec(res.income.expense, 'è²»ç”¨', res.income.totalExpense);
            inc += `<tr class="total-row" style="background:#dcedc8"><td>æœ¬æœŸæ·¨åˆ©</td><td class="text-right">${fmt(res.income.netIncome)}</td></tr>`;
            document.querySelector('#incomeTable tbody').innerHTML = inc;
            
            let eq = `<tr><td>ä»¥å‰å¹´åº¦/æœˆç´¯ç©ç›ˆé¤˜</td><td class="text-right">${fmt(res.equity.retainedStart)}</td></tr><tr><td>åŠ ï¼šæœ¬æœŸæ·¨åˆ©</td><td class="text-right">${fmt(res.equity.netIncome)}</td></tr><tr><td>åŠ ï¼šè‚¡æœ¬é¤˜é¡</td><td class="text-right">${fmt(res.equity.capital)}</td></tr><tr class="total-row"><td>æœŸæœ«æ¬Šç›Šç¸½é¡</td><td class="text-right">${fmt(res.equity.total)}</td></tr>`;
            document.querySelector('#equityTable tbody').innerHTML = eq;

            let cf = `<tr class="subtotal-row"><td colspan="2">ç‡Ÿæ¥­æ´»å‹•</td></tr>` +
                     `<tr><td class="indent">æœ¬æœŸæ·¨åˆ©</td><td class="text-right">${fmt(res.cashFlow.operating.netIncome)}</td></tr>` +
                     `<tr><td class="indent">åŠ ï¼šæŠ˜èˆŠèˆ‡æ”¤æ</td><td class="text-right">${fmt(res.cashFlow.operating.depreciation)}</td></tr>` +
                     `<tr><td class="indent">ç‡Ÿé‹è³‡ç”¢è®Šå‹•</td><td class="text-right">${fmt(res.cashFlow.operating.wcAsset)}</td></tr>` +
                     `<tr><td class="indent">ç‡Ÿé‹è² å‚µè®Šå‹•</td><td class="text-right">${fmt(res.cashFlow.operating.wcLiability)}</td></tr>` +
                     `<tr class="total-row"><td>ç‡Ÿæ¥­æ´»å‹•æ·¨ç¾é‡‘æµ</td><td class="text-right">${fmt(res.cashFlow.operating.total)}</td></tr>`;
            
            cf += `<tr class="subtotal-row"><td colspan="2">æŠ•è³‡æ´»å‹•</td></tr>`;
            res.cashFlow.investing.details.forEach(i => cf += `<tr><td class="indent-2">${i.name}</td><td class="text-right">${fmt(i.balance)}</td></tr>`);
            cf += `<tr class="total-row"><td>æŠ•è³‡æ´»å‹•æ·¨ç¾é‡‘æµ</td><td class="text-right">${fmt(res.cashFlow.investing.total)}</td></tr>`;

            cf += `<tr class="subtotal-row"><td colspan="2">ç±Œè³‡æ´»å‹•</td></tr>`;
            res.cashFlow.financing.details.forEach(i => cf += `<tr><td class="indent-2">${i.name}</td><td class="text-right">${fmt(i.balance)}</td></tr>`);
            cf += `<tr class="total-row"><td>ç±Œè³‡æ´»å‹•æ·¨ç¾é‡‘æµ</td><td class="text-right">${fmt(res.cashFlow.financing.total)}</td></tr>`;

            cf += `<tr class="total-row" style="background:#fff9c4"><td>æœ¬æœŸç¾é‡‘æ·¨è®Šå‹•</td><td class="text-right">${fmt(res.cashFlow.netChange)}</td></tr>`;
            document.querySelector('#cfTable tbody').innerHTML = cf;

            let bal = renderSec(res.balance.assets, 'è³‡ç”¢', res.balance.totalAssets) + renderSec(res.balance.liabilities, 'è² å‚µ', res.balance.totalLiabilities) + renderSec(res.balance.equity, 'æ¬Šç›Š', res.balance.totalEquity);
            const chk = Math.abs(res.balance.totalAssets - (res.balance.totalLiabilities + res.balance.totalEquity)) < 0.01;
            bal += `<tr class="total-row" style="color:${chk?'green':'red'}"><td colspan="2" align="center">è³‡ç”¢ = è² å‚µ+æ¬Šç›Š ${chk?'(å¹³è¡¡)':'(ä¸å¹³è¡¡)'}</td></tr>`;
            document.querySelector('#balanceSheetTable tbody').innerHTML = bal;
        }).withFailureHandler(err => { alert("å ±è¡¨éŒ¯èª¤ï¼š\n" + err.message); }).getFinancialReports(Number(y), m ? Number(m) : null);
      }
      function renderSec(arr, t, tot) {
        let h = `<tr class="subtotal-row"><td colspan="2">${t}</td></tr>`;
        h += arr.map(i=>`<tr><td class="indent">${i.name}</td><td class="text-right">${i.balance.toLocaleString()}</td></tr>`).join('');
        h += `<tr class="total-row"><td>å°è¨ˆ</td><td class="text-right">${tot.toLocaleString()}</td></tr>`;
        return h;
      }
    </script>
  </body>
</html>
